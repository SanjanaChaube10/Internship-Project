{% extends "accounts/base.html" %}
{% load static %}
{% block title %}Share & Review – {{ event.title }}{% endblock %}


{% block content %}
<link rel="stylesheet" href="{% static 'css/share_review.css' %}">
<section class="ud-wrap">
  <div class="container">
    <h1 class="ud-page-title">Share & Review – {{ event.title }}</h1>

    {% if messages %}
      {% for m in messages %}
        <div class="alert alert-{{ m.tags|default:'info' }}">{{ m }}</div>
      {% endfor %}
    {% endif %}

    <!-- Forms row -->
    <div class="ud-grid-2">
      <!-- UGC form -->
      <article class="ud-card">
  <div class="ud-card-head">
    <h2 class="ud-card-title">Post UGC</h2>
    <span class="ud-pill">Event: {{ event.event_id }}</span>
  </div>

  <form method="post" enctype="multipart/form-data" id="ugcForm">
    {% csrf_token %}
    <input type="hidden" name="intent" value="ugc">

    <!-- Type toggle -->
    <div class="ud-field">
      <label class="mb-2 d-block">Post Type</label>
      <div class="type-toggle" role="tablist" aria-label="UGC type">
        <input type="radio" id="type-photo" name="content_type" value="photo" checked hidden>
        <label for="type-photo" class="toggle-pill">Photo</label>
      </div>
      <small class="ud-note" id="typeHelp">Upload an image for Photo. </small>
    </div>

    <!-- File input + live preview -->
    <div class="ud-field">
      <label>Upload</label>
      <input type="file" name="upload_file" id="uploadFile" class="ud-input" accept="image/*" required>
      <div id="preview" class="ugc-preview" style="display:none; margin-top:10px;"></div>
    </div>

    <!-- Caption like Instagram -->
    <div class="ud-field">
      <label>Caption</label>
      <textarea name="content_data" id="caption" rows="3" class="ud-input" maxlength="150" placeholder="Write a caption…"></textarea>
      <div class="char-hint"><span id="capCount">0</span>/150</div>
    </div>

    <div class="ud-actions">
      <button type="submit" class="ud-btn">Share</button>
    </div>
  </form>
</article>


      <!-- Review form -->
      <article class="ud-card">
        <div class="ud-card-head">
          <h2 class="ud-card-title">Write a Review</h2>
        </div>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="intent" value="review">
          <div class="ud-field">
            <label>Rating</label>
            <select name="rating" class="ud-input">
              <option value="5">5 - Loved it</option>
              <option value="4">4 - Great</option>
              <option value="3">3 - Good</option>
              <option value="2">2 - Okay</option>
              <option value="1">1 - Meh</option>
              <option value="0">0 - No rating</option>
            </select>
          </div>
          <div class="ud-field">
            <label>Comment</label>
            <textarea name="comment" rows="3" class="ud-input" placeholder="Share your thoughts…"></textarea>
          </div>
          <div class="ud-actions">
            <button type="submit" class="ud-btn">Post Review</button>
          </div>
        </form>
      </article>
    </div>

    <!-- Lists row -->
    <div style="height:18px"></div>
    <div class="ud-grid-2">
      <!-- Recent UGC -->
      <article class="ud-card">
        <div class="ud-card-head">
          <h2 class="ud-card-title">Recent UGC</h2>
        </div>
        {% if ugc_list %}
          <ul class="ud-list">
            {% for u in ugc_list %}
              <li>
                <span class="ud-ugc-type">{{ u.content_type|title }}</span> —
                {{ u.content_data|default:"(no text)" }}
                <span class="ud-muted"> · {{ u.posted_on|date:"M d, Y" }}</span>
                {% if u.content_type == "photo" and u.photos.all %}
                  <div class="ud-note" style="margin-left:12px;">
                    Photo URL: {{ u.photos.all.0.image_url }}
                  </div>
                {% endif %}
                {% if u.user_id == account_user.user_id %}
                  <span class="ud-pill ud-own">yours</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="ud-muted">No UGC yet for this event.</p>
        {% endif %}
      </article>

      <!-- Recent Reviews -->
      <article class="ud-card">
        <div class="ud-card-head">
          <h2 class="ud-card-title">Recent Reviews</h2>
        </div>
        {% if reviews %}
          <ul class="ud-list">
            {% for r in reviews %}
              <li>
                <span class="ud-review-rating">★ {{ r.rating }}/5</span>
                {% if r.comment %} — {{ r.comment }}{% endif %}
                <span class="ud-muted"> · {{ r.date_posted|date:"M d, Y" }}</span>
                {% if r.user_id == account_user.user_id %}
                  <span class="ud-pill ud-own">yours</span>
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="ud-muted">No reviews yet for this event.</p>
        {% endif %}
      </article>
    </div>
  </div>
</section>

<script>
  // (optional) show/hide file input for Text-only posts
  const typeSel = document.getElementById('ugcType');
  const fileRow = document.getElementById('fileRow');
  function toggleFile() {
    fileRow.style.display = (typeSel.value === 'text') ? 'none' : 'block';
  }
  toggleFile();
  typeSel.addEventListener('change', toggleFile);
</script>

<script>
(function () {
  'use strict';

  const photoRadio = document.getElementById('type-photo');
  const videoRadio = document.getElementById('type-video');
  const fileInput  = document.getElementById('uploadFile');
  const preview    = document.getElementById('preview');
  const caption    = document.getElementById('caption');
  const capCount   = document.getElementById('capCount');

  function updateAccept() {
    if (!fileInput) return;
    fileInput.setAttribute('accept', photoRadio && photoRadio.checked ? 'image/' : 'video/');
    // reset preview on toggle
    if (preview) {
      preview.style.display = 'none';
      preview.innerHTML = '';
    }
    if (fileInput) fileInput.value = '';
  }

  if (photoRadio) photoRadio.addEventListener('change', updateAccept);
  if (videoRadio) videoRadio.addEventListener('change', updateAccept);

  if (fileInput) {
    fileInput.addEventListener('change', function () {
      const file = this.files && this.files[0];
      if (!preview) return;

      if (!file) {
        preview.style.display = 'none';
        preview.innerHTML = '';
        return;
      }

      const url = URL.createObjectURL(file);
      preview.style.display = 'block';

      if (photoRadio && photoRadio.checked) {
        // ✅ template literal with backticks
        preview.innerHTML = `<img src="${url}" alt="preview">`;
      } 
    });
  }

  if (caption && capCount) {
    caption.addEventListener('input', function () {
      capCount.textContent = String(this.value.length);
    });
    // init count
    capCount.textContent = String(caption.value.length);
  }

  // initial accept & preview state
  updateAccept();
})();
</script>

{% endblock %}